<div class="row">
  <search-tools sobject="ticket.searchObject" scontroller="ticket">    
    <select class="form-control filter-option" ng-model="ticket.addOne.extra.reason" title="علت تیکت">
      <option value="">-- علت تیکت --</option>
      <option value="1">تسویه</option>
      <option value="2">خرابی</option>
      <option value="3">استهلاک</option>
      <option value="0">غیره</option>
    </select>

    <select class="form-control filter-option" ng-model="ticket.addOne.extra.ticket_type" title="نوع تیکت">
      <option value="">-- نوع تیکت --</option>
      <option value="1">خرید</option>
      <option value="2">تخصیص</option>
      <option value="3">عودت</option>
      <option value="0">غیره</option>
    </select>
    از تاریخ :
    <div class="sort-option-edited">
      <adm-dtp ng-model="ticket.addOne.extra.datetime__gte" title="ابتدا بازه زمانی" options='{format: "hh:mm YYYY-MM-DD",dtpType : "date&time"}'>
        <input type='text' ng-model='date' class="form-control" placeholder="ابتدا بازه زمانی" dtp-input />
      </adm-dtp>
    </div>
    تا تاریخ :
    <div class="sort-option-edited">
      <adm-dtp ng-model="ticket.addOne.extra.datetime__lte" title="پایان بازه زمانی" options='{format: "hh:mm YYYY-MM-DD",dtpType : "date&time"}'>
        <input type='text' ng-model='date' class="form-control" placeholder="پایان بازه زمانی" dtp-input />
      </adm-dtp>
    </div>
  </search-tools>
  <div class="col-md-12 col-sm-12 col-xs-12">
    <div class="x_panel">
      <div class="x_title">
        <h2><i class="fa"></i>تیکت‌ها</h2>
        <button type="button" ng-if = "checkWrite('ticket')" class="btn btn-success btn-sm pull-left" name="button" ng-click="openModal()">
          تیکت جدید
        </button>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        <table class="table table-striped jambo_table asset-tables">
          <thead>
            <tr>
              <th>#</th>
              <th>عنوان</th>
              <th>توضیحات</th>
              <th>نوع تیکت</th>
              <th>علت تیکت</th>
              <th>زمان ایجاد</th>
              <th></th>
              <th ng-if = "checkWrite('ticket')"></th>
            </tr>
          </thead>
          <tbody ng-hide="load">
            <tr ng-repeat = "list in ticket.note">
              <td>{{ (page-1)*10 + $index + 1 | pNumber}}</td>
              <td>{{list.title | lengthLimit:30}}</td>
              <td>{{list.description | lengthLimit:30}}</td>
              <td>{{list.ticket_type | ticketType}}</td>
              <td>{{list.reason | ticketReason}}</td>
              <td>{{ list.datetime | jalaliDate}}</td>
              <td></td>
              <td>
                <a ng-click="ticket.getObject(list.id); editMode = true" href>
                  <i class="fa fa-lg fa-eye" aria-hidden="true"></i>
                </a>
              </td>
            </tr>
          </tbody>
        </table>
        <req-pagination itemmeta="meta" itempage="page" controller="ticket" config="ticket.paginationConfig"></req-pagination>
      </div>
    </div>
  </div>
</div>

<!-- ticket Modal -->
<div class="modal fade" id="ticketModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <div class="pull-left">
          <button type="button" ng-if = "checkWrite('ticket')" ng-show = "stage == 0 && !editMode" ng-disabled="!ticketForm.$valid" ng-click="ticket.sendOrEdit(editMode)" class="btn btn-success">ذخیره</button>
          <button type="button" class="btn btn-info" ng-show = "stage != 0" ng-click="stage = 0">بازگشت</button>
          <button type="button" class="btn btn-danger" ng-click="reset()" data-dismiss="modal">بستن</button>
        </div>
        <div class="pull-left load-spinner" ng-show = "loadModal">
          <i class="fa fa-spinner fa-pulse fa-2x" ></i>
        </div>
        <h3 class="modal-title" ng-hide="editMode">افزودن تیکت جدید</h3>
        <h3 class="modal-title" ng-show="editMode">مشاهده ی تیکت</h3>
      </div>
      <div class="modal-body">

        <div ng-show="stage == 0">
          <form name="ticketForm" role="form" ng-hide="loadModal" novalidate>
            
            <div class="row">
              <fieldset ng-disabled ="!checkWrite('ticket')">
                <div class="col-sm-6">
                  <div class="form-group">
                    <label ng-show="!editMode">عنوان * </label>
                    <label ng-show="editMode">عنوان</label>
                    <input type="text" class="form-control" ng-model="ticket.obj.title" required ng-hide="editMode">
                    <p ng-show="editMode"> {{ticket.obj.title | lengthLimit:20}} </p>
                  </div>
                </div>
                <div class="col-sm-6">
                  <div class="form-group" ng-show="!editMode || ticket.obj.product">
                    <label>کالا</label>
                    <div class="input-group" ng-hide="editMode">
                      <input type="text" class="form-control" ng-model="ticket.obj.product.model" disabled>
                      <span class="input-group-btn">
                        <button type="button" ng-disabled="!checkWrite('ticket') || editMode" class="btn btn-info btn-beside-input" ng-hide="ticket.obj.product && ticket.obj.product!=''" ng-click="ticket.selectThings(1,'product','use_case=0&model')">انتخاب</button>
                        <button class="btn btn-warning btn-beside-input" type="button"
                        ng-show="ticket.obj.product && ticket.obj.product!=''" 
                        ng-click="ticket.deleteKey(ticket.obj,'product')"> 
                          حذف کالا </button>
                      </span>
                    </div>
                    <p ng-show="editMode"> {{ticket.obj.product.model | lengthLimit:20}} </p>
                  </div>
                </div>
                <div class="clearfix"></div>
                <!--
                  date and status only in editMode
                  use ticketStatus filter for show  status
                 -->
                <div class="col-xs-6" ng-show="editMode" >
                  <label>زمان</label>
                  <p> {{ticket.obj.datetime | jalaliDate}} </p>
                </div>
                <div class="col-xs-3" ng-show="editMode">
                  <label>وضعیت</label>
                  <p> {{ticket.obj.status | ticketStatus}} </p>
                </div>
                <div style="padding-top=0.5em;" class="col-xs-3" ng-show="editMode">
                  <button style="float:left" type="button" class="btn btn-success" ng-click="ticket.changeStatus(1)" 
                  ng-show="ticket.obj.status == 0 && !loadStatus">
                    شروع پیگیری
                  </button>
                  <button style="float:left" type="button" class="btn btn-warning" ng-click="ticket.changeStatus(2)" 
                  ng-show="ticket.obj.status == 1 && !loadStatus">
                    اتمام
                  </button>
                  <i ng-show="loadStatus" class="fa fa-spinner fa-pulse fa-2x" ></i>
                </div>
                <div class="clearfix"></div>

                <div class="col-sm-6">
                  <div class="form-group">
                    <label ng-hide="editMode">علت تیکت*</label>
                    <label ng-show="editMode">علت تیکت</label>
                    <select class="form-control" ng-model="ticket.obj.reason" title="علت تیکت" required 
                    ng-hide="editMode">
                      <option value="1">تسویه</option>
                      <option value="2">خرابی</option>
                      <option value="3">استهلاک</option>
                      <option value="0">غیره</option>
                    </select>
                    <p ng-show="editMode"> {{ticket.obj.reason | ticketReason}} </p>
                  </div>
                </div>

                <div class="col-sm-6">
                  <div class="form-group">
                    <label ng-hide="editMode">نوع تیکت*</label>
                    <label ng-show="editMode">نوع تیکت</label>

                    <select class="form-control" ng-model="ticket.obj.ticket_type" title="نوع تیکت" required
                    ng-hide="editMode">
                      <option value="1">خرید</option>
                      <option value="2">تخصیص</option>
                      <option value="3">عودت</option>
                      <option value="0">غیره</option>
                    </select>
                    <p ng-show="editMode"> {{ticket.obj.ticket_type | ticketType}} </p>
                  </div>
                </div>
                <div class="clearfix"></div>

                <!--
                  warehouse_id is forbidden when source is normal warehouse
                 -->
                <div class="col-sm-6" ng-show="editMode">
                  <div class="form-group">
                    <label>انبار مبدا</label>
                    <p> {{ticket.obj.from_warehouse.title | lengthLimit:30}} </p>
                  </div>
                </div>
              
                <div class="col-sm-6">
                  <div class="form-group" ng-show="ticket.allowedSource || editMode">
                    <label>انبار مقصد</label>
                    <div class="input-group" ng-hide="editMode">
                      <input type="text" class="form-control" ng-model="ticket.obj.to_warehouse.title" disabled>
                      <span class="input-group-btn">
                        <button type="button" class="btn btn-info btn-beside-input"
                        ng-disabled="editMode || !checkWrite('ticket') || !ticket.allowedSource"  
                        ng-hide="ticket.obj.to_warehouse && ticket.obj.to_warehouse!=''" 
                        ng-click="ticket.selectThings(2,'warehouse','title')">
                          انتخاب</button>
                        <button class="btn btn-warning btn-beside-input" type="button"
                        ng-show="ticket.obj.to_warehouse && ticket.obj.to_warehouse!=''" 
                        ng-click="ticket.deleteKey(ticket.obj,'to_warehouse')"> 
                          حذف انبار مقصد </button>
                      </span>
                    </div>
                    <p ng-show="editMode"> {{ticket.obj.to_warehouse.title | lengthLimit:30}} </p>
                  </div>
                </div>

                <div class="clearfix"></div>
              
                <div class="col-xs-12">
                  <div class="form-group">
                    <label ng-hide="editMode">توضیحات تیکت*</label>
                    <label ng-show="editMode">توضیحات تیکت</label>

                    <div>
                      <textarea class="form-control" style="resize:none" rows="3" ng-model="ticket.obj.description" required
                      ng-hide="editMode">
                      </textarea>
                      <p ng-show="editMode" style="min-height:2em; max-height:5em; overflow-y:auto"> 
                        {{ticket.obj.description}}
                      </p>
                    </div>
                  </div>
                </div>
                <div class="clearfix"></div>
              </fieldset>
            </div>
          </form> 
          <!-- message is only show in editMode -->
          <div class="message-body" ng-show="editMode && !loadModal">
            <hr>
            <h4>پیام ها</h4>
            <div class="message-list-container">
              <div ng-class="{'ticket-message-self':msg.sender.card_no == userCard}" class="ticket-message" ng-repeat="msg in ticket.obj.messages">
                <h4>
                  {{msg.sender.card_no | lengthLimit:20}}
                  <small> به تاریخ {{msg.datetime | jalaliDate}} </small>
                </h4>
                <p> {{msg.text}} </p>
              </div>
            </div>
            <br />
            <div class="row">
              <div class="col-md-10">
                <input type="text" ng-model="ticket.tmp.text" placeholder="پیام را اینجا بنویسید ..." class="form-control">
              </div>
              <div class="col-md-2">
                <button type="button" class="btn btn-warning" ng-click="ticket.addMessage()" 
                ng-disabled="ticket.tmp.text =='' || !ticket.tmp.text" ng-hide="sendingMessage">
                  ارسال
                </button>
                <i ng-show="sendingMessage" class="fa fa-spinner fa-pulse fa-2x" ></i>
              </div>
            </div>

          </div>
          
        </div>
        <!-- End of stage 0 -->

        <!-- product selection stage -->
        <search-stage ng-show = "stage == 1" obj="ticket.selectProductObj" controller = "ticket"></search-stage>
        <!-- End of Stage 1 -->

        <!-- destination warehouse selection stage -->
        <search-stage ng-show = "stage == 2" obj="ticket.selectDestinationObj" controller = "ticket"></search-stage>
        <!-- End of Stage 2 -->

      </div>
      <div class="modal-footer">
        <p ng-show = "stage == 0 && !editMode"> −
          پر کردن فیلد هایی که با * مشخص شده اجباری است
        </p>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="pull-left close" data-dismiss="modal" aria-label="Close" ng-hide ="loadModal">
          <span aria-hidden="true">&times;</span>
        </button>
        <div class="pull-left load-spinner" ng-show = "loadModal">
          <i class="fa fa-spinner fa-pulse fa-2x" ></i>
        </div>
        <h4 class="modal-title" id="myModalLabel" ng-hide = "editMode">حذف تیکت</h4>
      </div>
      <div class="modal-body">
        آیا مایل به حذف تیکت
        "{{ticket.toDeleteTitle | lengthLimit:30}}"
        هستید؟
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">خیر</button>
        <button type="button" class="btn btn-success" ng-click="ticket.deleteObject(ticket.toDeleteId)">بله</button>
      </div>
    </div>
  </div>
</div>
