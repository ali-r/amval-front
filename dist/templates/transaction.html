<div class="row">
  <search-tools sobject="transaction.searchObject" scontroller="transaction">    
    <select class="form-control filter-option" ng-model="transaction.addOne.extra.reason" title="علت تراکنش">
      <option value="">-- علت تراکنش --</option>
      <option value="0">تامین</option>
      <option value="1">تعمیرات</option>
      <option value="2">استهلاک</option>
      <option value="3">بدون دلیل</option>
    </select>

    <select class="form-control filter-option" ng-model="transaction.addOne.extra.transaction_type" title="نوع تراکنش">
      <option value="">-- نوع تراکنش --</option>
      <option value="0">تخصیص</option>
      <option value="1">عودت</option>
      <option value="2">انتقال</option>
    </select>
    از تاریخ :
    <div class="sort-option-edited">
      <adm-dtp ng-model="transaction.addOne.extra.datetime__gte" title="ابتدا بازه زمانی" options='{format: "hh:mm YYYY-MM-DD",dtpType : "date&time"}'>
        <input type='text' ng-model='date' class="form-control" placeholder="ابتدا بازه زمانی" dtp-input />
      </adm-dtp>
    </div>
    تا تاریخ :
    <div class="sort-option-edited">
      <adm-dtp ng-model="transaction.addOne.extra.datetime__lte" title="پایان بازه زمانی" options='{format: "hh:mm YYYY-MM-DD",dtpType : "date&time"}'>
        <input type='text' ng-model='date' class="form-control" placeholder="پایان بازه زمانی" dtp-input />
      </adm-dtp>
    </div>

    <div id="report-field" style="display:none" class="report-field">
      
      <div title="فیلتر براساس کالا" class="input-group report-field-option">
        <input type="text" class="form-control" placeholder="انتخاب کالا" ng-model="transaction.addOne.extra.product.model" readonly ng-click="transaction.openSelectionModal(0,'product','model')">
        <span class="input-group-btn">
          <button type="button" class="btn btn-danger btn-beside-input" ng-show="transaction.addOne.extra.product"
          ng-click="transaction.deleteKey(transaction.addOne.extra,'product')">
            <i class="fa fa-remove"></i>
          </button>
        </span>
      </div><!-- / product filter -->

      <div title="فیلتر براساس منبع" class="input-group report-field-option">
        <a class="dropdown-toggle" href data-toggle="dropdown" aria-expanded="false">
            <input type="text" class="form-control"  placeholder="انتخاب منبع" ng-model="transaction.addOne.extra.source.last_name" readonly  ng-hide="transaction.addOne.extra.source_type == 'warehouse'">
            <input type="text" class="form-control" placeholder="انتخاب منبع" ng-model="transaction.addOne.extra.source.title" readonly  ng-show="transaction.addOne.extra.source_type == 'warehouse'">
        </a>
        <ul id="dropdown-filter-source" class="dropdown-menu dropdown-menu-right" role="menu">
          <li>
            <a ng-click="transaction.openSelectionModal(1,'user','model');transaction.addOne.extra.source_type='user'" href>کاربر</a>
          </li>
          <li>
            <a ng-click="transaction.openSelectionModal(2,'warehouse','model');transaction.addOne.extra.source_type='warehouse'" href>انبار</a>
          </li>
        </ul>
        <span class="input-group-btn">
          <button type="button" class="btn btn-danger btn-beside-input" ng-show="transaction.addOne.extra.source"
          ng-click="transaction.deleteKey(transaction.addOne.extra,'source')">
            <i class="fa fa-remove"></i>
          </button>
        </span>
      </div><!-- / source filter -->

      <div title="فیلتر بر اساس مقصد" class="input-group report-field-option">
        <a class="dropdown-toggle" href data-toggle="dropdown" aria-expanded="false">
          <input type="text" class="form-control"  placeholder="انتخاب مقصد" ng-model="transaction.addOne.extra.destination.last_name"     readonly  ng-hide="transaction.addOne.extra.destination_type == 'warehouse'">
          <input type="text" class="form-control" placeholder="انتخاب مقصد" ng-model="transaction.addOne.extra.destination.title" readonly  ng-show="transaction.addOne.extra.destination_type == 'warehouse'">
        </a>
        <ul id="dropdown-filter-destination" class="dropdown-menu dropdown-menu-right" role="menu">
          <li>
            <a ng-click="transaction.openSelectionModal(3,'user','model');transaction.addOne.extra.destination_type='user'" href>کاربر</a>
          </li>
          <li>
            <a ng-click="transaction.openSelectionModal(4,'warehouse','model');transaction.addOne.extra.destination_type='warehouse'" href>انبار</a>
          </li>
        </ul>
        <span class="input-group-btn">
          <button type="button" class="btn btn-danger btn-beside-input" ng-show="transaction.addOne.extra.destination"
          ng-click="transaction.deleteKey(transaction.addOne.extra,'destination')">
            <i class="fa fa-remove"></i>
          </button>
        </span>
      </div><!-- / destination filter -->

    </div>
  </search-tools>
  <div class="col-md-12 col-sm-12 col-xs-12">
    <div class="x_panel">
      <div class="x_title">
        <h2><i class="fa"></i>تراکنش‌ها</h2>
        <button type="button" ng-if = "checkWrite('transaction')" class="btn btn-success btn-sm pull-left" name="button" ng-click="openModal()">
          تراکنش جدید
        </button>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        <table class="table table-striped jambo_table asset-tables">
          <thead>
            <tr>
              <th>#</th>
              <th>مدل کالا</th>
              <th>منبع</th>
              <th>مقصد</th>
              <th>علت تراکنش</th>
              <th>نوع تراکنش </th>
              <th></th>
              <th ng-if = "checkWrite('transaction')"></th>
            </tr>
          </thead>
          <tbody ng-hide="load">
            <tr ng-repeat = "list in transaction.note">
              <td>{{ (page-1)*perPage + $index + 1 | pNumber}}</td>
              <td>{{list.product.model | lengthLimit:30}}</td>
              <td>{{list.source | userOrWarehouseName| lengthLimit:30}}</td>
              <td>{{list.destination | userOrWarehouseName | lengthLimit:30}}</td>
              <td>{{list.reason | reasonType}}</td>
              <td>
                <button class="btn btn-sm" disabled
                ng-class="{'btn-info':list.transaction_type==0, 'btn-danger':list.transaction_type==1, 'btn-default':list.transaction_type==2}">
                  {{list.transaction_type | transactionType}}
                </button>
              </td>

              <td></td>
              <td>
                <a ng-click="transaction.getObject(list.id); editMode = true" href>
                  <i class="fa fa-lg fa-eye" aria-hidden="true"></i>
                </a>
              </td>
            </tr>
          </tbody>
        </table>
        <req-pagination itemmeta="meta" itempage="page" controller="transaction" config="transaction.paginationConfig"></req-pagination>
      </div>
    </div>
  </div>
</div>

<!-- Transaction Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <div class="pull-left">
          <button type="button" ng-if = "checkWrite('transaction')" ng-show = "stage == 0 && !editMode" ng-disabled="!transactionForm.$valid || !transaction.obj.destination" ng-click="transaction.sendOrEdit(editMode)" class="btn btn-success">ذخیره</button>
          <button type="button" class="btn btn-info" ng-show = "stage != 0" ng-click="stage = 0">بازگشت</button>
          <button type="button" class="btn btn-danger" ng-click="reset()" data-dismiss="modal">بستن</button>
        </div>
        <div class="pull-left load-spinner" ng-show = "loadModal">
          <i class="fa fa-spinner fa-pulse fa-2x" ></i>
        </div>
        <h3 class="modal-title" ng-hide="editMode">افزودن تراکنش جدید</h3>
        <h3 class="modal-title" ng-show="editMode">مشاهده ی تراکنش</h3>
      </div>
      <div class="modal-body">

        <div ng-show="stage == 0">
          <form name="transactionForm" role="form" ng-hide="loadModal" novalidate>
            
            <div class="row">
              <fieldset ng-disabled ="!checkWrite('transaction')">
                <div class="col-sm-6">
                  <div class="form-group">
                    <label>کالا*</label>
                    <div class="input-group">
                      <input type="text" class="form-control" ng-model="transaction.obj.product.model" required disabled>
                      <span class="input-group-btn">
                        <button type="button" ng-disabled="!checkWrite('transaction') || editMode" class="btn btn-info btn-beside-input" ng-click="transaction.selectThings(1, 'product', '?use_case=1')">انتخاب</button>
                      </span>
                    </div>
                  </div>
                </div>
                <div class="col-sm-6">
                  <div class="form-group" ng-show="editMode">
                    <label>تاریخ تراکنش</label>
                    <p class="data-show" style="padding:5px 5px;">
                      {{transaction.obj.datetime | pNumber}}
                    </p>
                  </div>
                </div>
                <div class="clearfix"></div>
                <hr>
                <div class="col-sm-6">
                  <div class="form-group">
                    <label>مقصد*</label>
                    <div class="input-group">
                      <input type="text" class="form-control" ng-hide="transaction.obj.destination.type=='Warehouse'" ng-model="transaction.obj.destination.obj.last_name" disabled>
                      <input type="text" class="form-control" ng-show="transaction.obj.destination.type=='Warehouse'" ng-model="transaction.obj.destination.obj.title" disabled>
                      <div class="input-group-btn">
                        <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-expanded="false"
                        ng-disabled="editMode">
                          انتخاب
                          <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-right" role="menu">
                          <li>
                            <a ng-click="transaction.selectThings(2, 'user', '')" href>کاربر</a>
                          </li>
                          <li>
                            <a ng-click="transaction.selectThings(3, 'warehouse', '')" href>انبار</a>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              
                <!-- source selection -->
                <div class="col-xs-6">
                  <div class="form-group">
                    <label>منبع</label>
                    <p class="data-show" ng-show="!editMode">
                      {{transaction.obj.product.holder | userOrWarehouseName | lengthLimit:30}}
                    </p>
                    <p class="data-show" ng-show="editMode">
                      {{transaction.obj.source | userOrWarehouseName | lengthLimit:30}}
                    </p>
                  </div>
                </div>
                  
                <div class="clearfix"></div>
                <hr>
                <!-- transaction type and reason selection -->
                <div class="col-xs-6">
                    <div class="form-group">
                      <label>نوع تراکنش*</label>
                      <div>
                        <select class="form-control" ng-model="transaction.obj.transaction_type" required ng-disabled="editMode">
                          <option value="0">تخصیص</option>
                          <option value="1">عودت</option>
                          <option value="2">انتقال</option>
                        </select>
                      </div>
                    </div>
                </div>
                
              
                <div class="col-xs-6">
                  <div class="form-group">
                    <label>علت تراکنش*</label>
                    <select class="form-control" ng-model="transaction.obj.reason" required ng-disabled="editMode">
                      <option value="0">تامین</option>
                      <option value="1">تعمیرات</option>
                      <option value="2">استهلاک</option>
                      <option value="3">بدون دلیل</option>
                    </select>
                  </div>
                </div>
                <div class="clearfix"></div>
                <hr>
              
                <div class="col-xs-12" >
                  <div class="form-group">
                    <label>توضیحات تراکنش*</label>
                    <div>
                      <textarea class="form-control" style="resize:none" rows="4" ng-model="transaction.obj.details" required
                      ng-disabled="editMode">
                      </textarea>
                    </div>
                  </div>
                </div>

              </fieldset>
            </div>



          </form> 
        </div>
        <!-- End of stage 0 -->

        <!-- Product selection -->
        <div class="row" ng-show="stage == 1">
          <div class="col-md-12">
            <div class="panel panel-info">
              <div class="panel-heading">
                انتخاب کالا
                <div class="pull-left">
                  <i ng-show = "loadSearch" class="fa fa-refresh fa-spin"></i>
                </div>
              </div>
              <div class="panel-body">
                <form name="searchForm" role="form" novalidate>
                      <div class="input-group">
                        <input type="text" class="form-control" placeholder="جستجو کالا" name="searchText" ng-model="transaction.tmp.searchQuery" required>
                        <span class="input-group-btn">
                          <button type="button" ng-disabled = "searchForm.$invalid" class="btn btn-info btn-beside-input" ng-click="transaction.search('product', '?use_case=1&model__contains=' + transaction.tmp.searchQuery)">
                            جستجو
                          </button>
                        </span>
                      </div>
                  </form>
                  <table class="table table-hover table-border" ng-hide = "transaction.tmp.searchResult == '' || loadSearch">
                    <colgroup>
                      <col span="1" style="width: 10%;">
                      <col span="1" style="width: 30%;">
                      <col span="1" style="width: 30%;">
                      <col span="1" style="width: 20%;">
                      <col span="1" style="width: 10%;">
                    </colgroup>
                    <thead>
                      <tr>
                        <th>ردیف</th>
                        <th>
                          مدل
                        </th>
                        <th>
                          شماره سریال
                        </th>
                        <th>
                          زیر گروه
                        </th>
                        <th>انتخاب</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr ng-repeat = "list in transaction.tmp.searchResult">
                        <td>
                          {{ $index + 1 }}
                        </td>
                        <td>{{list.model | lengthLimit:25}}</td>
                        <td>{{list.serial_number | lengthLimit:20}}</td>
                        <td>
                          {{list.subgroup.title | lengthLimit:20}}
                        </td>
                        <td>
                          <a ng-click="transaction.addProduct(list)" href>
                            <i class="fa fa-check-square-o fa-lg"></i>
                          </a>
                        </td>
                      </tr>
                    </tbody>
                </table>
              </div>
            </div>
          <!-- /.box-body -->
          </div>
        </div>
        <!-- End of stage 1 -->

        <!-- User selection -->
        <div class="row" ng-show="stage == 2">
          <div class="col-md-12">
            <div class="panel panel-info">
              <div class="panel-heading">
                انتخاب کاربر مقصد
                <div class="pull-left">
                  <i ng-show = "loadSearch" class="fa fa-refresh fa-spin"></i>
                </div>
              </div>
              <div class="panel-body">
                <form name="searchForm" role="form" novalidate>
                      <div class="input-group">
                        <input type="text" class="form-control" placeholder="جستجو کاربر" name="searchText" ng-model="transaction.tmp.searchQuery" required>
                        <span class="input-group-btn">
                          <button type="button" ng-disabled = "searchForm.$invalid" class="btn btn-info btn-beside-input" ng-click="transaction.search('user', '?last_name__contains=' + transaction.tmp.searchQuery)">
                            جستجو
                          </button>
                        </span>
                      </div>
                  </form>
                  <table class="table table-hover table-border" ng-hide = "transaction.tmp.searchResult == '' || loadSearch">
                    <thead>
                      <tr>
                        <th>ردیف</th>
                        <th>
                          نام
                        </th>
                        <th>
                          نام خانوادگی
                        </th>
                        <th>
                          نام کاربری
                        </th>
                        <th>انتخاب</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr ng-repeat = "list in transaction.tmp.searchResult">
                        <td>
                          {{ $index + 1 }}
                        </td>
                        <td>{{list.first_name | lengthLimit:20}}</td>
                        <td>{{list.last_name | lengthLimit:20}}</td>
                        <td>
                          {{list.card_no | lengthLimit:20}}
                        </td>
                        <td>
                          <a ng-click="transaction.addDestination('User',list)" href>
                            <i class="fa fa-check-square-o fa-lg"></i>
                          </a>
                        </td>
                      </tr>
                    </tbody>
                </table>
              </div>
            </div>
          <!-- /.box-body -->
          </div>
        </div>
        <!-- End of stage 2 -->

        <!-- Warehouse selection -->
        <div class="row" ng-show="stage == 3">
          <div class="col-md-12">
            <div class="panel panel-info">
              <div class="panel-heading">
                انتخاب انبار مقصد
                <div class="pull-left">
                  <i ng-show = "loadSearch" class="fa fa-refresh fa-spin"></i>
                </div>
              </div>
              <div class="panel-body">
                <form name="searchForm" role="form" novalidate>
                      <div class="input-group">
                        <input type="text" class="form-control" placeholder="جستجو انبار" name="searchText" ng-model="transaction.tmp.searchQuery" required>
                        <span class="input-group-btn">
                          <button type="button" ng-disabled = "searchForm.$invalid" class="btn btn-info btn-beside-input" ng-click="transaction.search('warehouse', '?title__contains=' + transaction.tmp.searchQuery)">
                            جستجو
                          </button>
                        </span>
                      </div>
                  </form>
                  <table class="table table-hover table-border" ng-hide = "transaction.tmp.searchResult == '' || loadSearch">
                    <thead>
                      <tr>
                        <th>ردیف</th>
                        <th>
                          نام انبار
                        </th>
                        <th>
                          محل
                        </th>
                        <th>
                          شماره تلفن
                        </th>
                        <th>انتخاب</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr ng-repeat = "list in transaction.tmp.searchResult">
                        <td>
                          {{ $index + 1 }}
                        </td>
                        <td>{{list.title  | lengthLimit:20}}</td>
                        <td>{{list.location | lengthLimit:20}}</td>
                        <td dir="ltr">
                          {{list.phone | lengthLimit:20}}
                        </td>
                        <td>
                          <a ng-click="transaction.addDestination('Warehouse',list)" href>
                            <i class="fa fa-check-square-o fa-lg"></i>
                          </a>
                        </td>
                      </tr>
                    </tbody>
                </table>
              </div>
            </div>
          <!-- /.box-body -->
          </div>
        </div>
        <!-- End of stage 3 -->

      </div>
      <div class="modal-footer">
        <p ng-show = "stage == 0 && !editMode"> −
          پر کردن فیلد هایی که با * مشخص شده اجباری است
        </p>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="pull-left close" data-dismiss="modal" aria-label="Close" ng-hide ="loadModal">
          <span aria-hidden="true">&times;</span>
        </button>
        <div class="pull-left load-spinner" ng-show = "loadModal">
          <i class="fa fa-spinner fa-pulse fa-2x" ></i>
        </div>
        <h4 class="modal-title" id="myModalLabel" ng-hide = "editMode">حذف تراکنش</h4>
      </div>
      <div class="modal-body">
        آیا مایل به حذف تراکنش
        "{{transaction.toDeleteTitle | lengthLimit:30}}"
        هستید؟
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">خیر</button>
        <button type="button" class="btn btn-success" ng-click="transaction.deleteObject(transaction.toDeleteId)">بله</button>
      </div>
    </div>
  </div>
</div>

<!-- Select Modal -->
<div class="modal fade" id="selectModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <div class="pull-left">
          <button type="button" class="btn btn-danger" ng-click="reset()" data-dismiss="modal">بستن</button>
        </div>
        <div class="pull-left load-spinner" ng-show = "loadModal">
          <i class="fa fa-spinner fa-pulse fa-2x" ></i>
        </div>
        <!-- <h3 class="modal-title">مدال انتخاب</h3> -->
      </div>

      <div class="modal-body">
        <!-- stage = 0 for product selection -->
        <search-stage ng-show = "stage == 0" obj="transaction.selectProductObj" controller = "transaction" target="extra" subbase="addOne" func="controller.closeSelectionModal()"></search-stage>

        <!-- stage = 1 for user source selection -->
        <search-stage ng-show = "stage == 1" obj="transaction.selectUserSourceObj" controller = "transaction" target="extra" subbase="addOne" func="controller.closeSelectionModal()"></search-stage>
        
        <!-- stage = 2 for producer selection -->
        <search-stage ng-show = "stage == 2" obj="transaction.selectWarehouseSourceObj" controller = "transaction" target="extra" subbase="addOne" func="controller.closeSelectionModal()"></search-stage>

        <!-- stage = 3 for seller selection -->
        <search-stage ng-show = "stage == 3" obj="transaction.selectUserDestinationObj" controller = "transaction" target="extra" subbase="addOne" func="controller.closeSelectionModal()"></search-stage>

        <!-- stage = 4 for gaurantor selection -->
        <search-stage ng-show = "stage == 4" obj="transaction.selectWarehouseDestinationObj" controller = "transaction" target="extra" subbase="addOne" func="controller.closeSelectionModal()"></search-stage>

        
      </div>
      <div class="modal-footer">
      </div><!-- /.modal-footer -->
    </div>
  </div>
</div>
