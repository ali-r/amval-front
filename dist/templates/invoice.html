<div class="row">

    <!-- Search Object -->
    <div class="col-xs-12">
        <div class="x_panel">

            <div class="x_content">
                <search-tools sobject="invoice.searchObject" scontroller="invoice"></search-tools>
            </div>
        </div>
    </div>
    <!-- /Search Object-->

    <div class="col-xs-12">

        <!-- invoice list -->
        <div class="col-xs-6">
            <div class="x_panel">
                <div class="x_title">
                    <h2><i class="fa"></i>لیست فاکتورها</h2>
                    <button type="button" ng-if = "checkWrite('invoice')" class="btn btn-success btn-sm pull-left" name="button" ng-click="invoice.setNewInvoiceForm()">
                        فاکتور جدید
                    </button>
                    <div class="clearfix"></div>
                </div><!-- /.x_title-->
                <div class="x_content">
                    <table class="table table-striped jambo_table asset-tables">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>شماره فاکتور</th>
                            <th>قیمت کل</th>
                            <th></th>
                            <th></th>
                            <th ng-if = "checkWrite('invoice')"></th>
                        </tr>
                        </thead>
                        <tbody ng-hide="load">
                        <tr ng-repeat = "list in invoice.note">
                            <td>{{ (page-1)*10 + $index + 1 }}</td>
                            <td>{{list.invoice_no}}</td>
                            <td>{{list.price}}</td>
                            <td>
                                <a ng-click="invoice.readInvoice(list.id)" href>
                                    <i class="fa fa-lg"  ng-class = "{'fa-pencil-square-o':checkWrite('invoice') , 'fa-eye' : !checkWrite('invoice')}" aria-hidden="true"></i>
                                </a>
                            </td>
                            <td ng-if = "checkWrite('invoice')">
                                <a ng-click="invoice.openDeleteModal(list.id,list.invoice_no,2)" href>
                                    <i class="fa fa-lg fa-trash-o" aria-hidden="true"></i>
                                </a>
                            </td>
                        </tr>
                        </tbody>

                    </table>
                    <req-pagination itemmeta="meta" itempage="page"></req-pagination>
                </div><!-- /.x_content-->
            </div><!-- /.x_panel-->
        </div>
        <!-- /invoice list -->

        <!-- edit and create column -->
        <div class="col-xs-6">
            <div class="x_panel" ng-hide="invoice.emptyForm">
                <div class="x_title" ng-click="invoice.test()">
                    <h2 ng-show="invoice.editCreate"><i class="fa"></i>ویرایش فاکتور</h2>
                    <h2 ng-hide="invoice.editCreate"><i class="fa"></i>ایجاد فاکتور جدید</h2>
                    <div class="clearfix"></div>
                </div><!-- /.x_title-->
                <div class="x_content">
                    <form name="invoiceForm" role="form"  novalidate>
                        <fieldset ng-disabled ="!checkWrite('invoice')">
                            <div class="box-body">
                                <div class="col-xs-12">
                                    <div class="form-group">
                                        <div class="input-group">
                                            <input type="text" class="form-control" ng-model="invoice.obj.buyer.last_name" placeholder="انتخاب خریدار" disabled>
                                            <span class="input-group-btn">
                                                <button type="button" class="btn btn-primary btn-beside-input" ng-click="invoice.selectBuyer()">انتخاب خریدار</button>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xs-12">
                                    <div class="form-group">
                                        <div class="input-group">
                                            <input type="text" class="form-control" ng-model="invoice.obj.seller.last_name" placeholder="انتخاب فروشنده" disabled>
                                            <span class="input-group-btn">
                                                <button type="button" class="btn btn-primary btn-beside-input" ng-click="invoice.selectSeller()">انتخاب فروشنده</button>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xs-12">
                                    <div class="form-group" ng-class=" {'has-error' : invoiceForm.invoice_no.$invalid && invoice.obj.invoice_no,
                      'has-success' : invoiceForm.invoice_no.$valid && invoice.obj.invoice_no } ">
                                        <input type="text" class="form-control" name="invoice_no" placeholder="شماره فاکتور" ng-model = "invoice.obj.invoice_no" required>
                                    </div>
                                </div>
                                <div class="col-xs-12">
                                    <div class="form-group" ng-class="{'has-success' : invoiceForm.datetime.$valid && invoice.obj.datetime}">
                                        <label>تاریخ فاکتور*</label>
                                        <adm-dtp  ng-model="invoice.obj.datetime" ></adm-dtp>
                                    </div>
                                </div>
                                <div class="col-xs-12">
                                    <div class="form-group" ng-class="{'has-success' : invoiceForm.num_of_products.$valid && invoice.obj.num_of_products}">
                                        <label>تعداد کالا</label>
                                        <input type="number" name="num_of_products" class="form-control" ng-model="invoice.obj.num_of_products" required>
                                    </div>
                                </div>

                                <div class="col-xs-12">
                                    <div class="form-group">
                                        <span class="input-group-btn">
                                            <button type="button" class="btn btn-primary" ng-click="invoice.addProduct()">افزودن کالا</button>
                                            <button type="button" class="btn btn-primary" ng-click="invoice.selectProduct()">انتخاب کالا</button>
                                        </span>
                                    </div>
                                </div>

                                <div class="col-xs-12">
                                    <div class="form-group">
                                        <table class="table table-striped jambo_table asset-tables">
                                            <thead>
                                                <tr>
                                                    <td>نام کالا</td>
                                                    <td>قیمت</td>
                                                    <td></td>
                                                </tr>
                                            </thead>
                                            <tbody ng-repeat = "product in invoice.obj.products">
                                                <tr>
                                                    <td> {{product.model}} </td>
                                                    <td> 
                                                        <form name="setProductPriceForm" role="form" novalidate>
                                                          <div class="input-group col-xs-6 col-xs-push-3">
                                                            <input dir="ltr" type="number" min="0" class="form-control" name="productPrice" ng-model="product.price" required>
                                                          </div>
                                                          <p ng-show="setProductPriceForm.productPrice.$invalid" class="input-error-p">قیمت باید عددی بیشتر از صفر باشد</p>
                                                          <p ng-show="setProductPriceForm.productPrice.$error.number">* فقط اعداد مجاز هستند</p>
                                                        </form>

                                                    </td>
                                                    <td ng-if = "checkWrite('invoice')">
                                                        <a ng-click="invoice.openDeleteModal($index,product.model,1)" href>
                                                            <i class="fa fa-lg fa-trash-o" aria-hidden="true"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="col-xs-12">
                                    <div class="col-xs-4">
                                        <label>تصویر فاکتور</label>
                                    </div>
                                    <div class="col-xs-4">
                                        <div class="btn btn-info btn-sm" ngf-select="invoice.uploadPic()" ng-model="invoice.obj.scanned_invoice" name="file" ngf-pattern="'.jpg,.png,.jpeg,.png'"
                                             ngf-accept="'image/*'" ngf-max-size="2MB" ng-if="!invoice.obj.scanned_invoice && checkWrite('invoice')" ng-required="!invoice.obj.scanned_invoice" ng-disabled="uploading">افزودن تصویر</div>

                                        <button type="button" class="btn btn-sm btn-danger" ng-if="invoice.obj.scanned_invoice && checkWrite('invoice')"
                                                ng-click=" invoice.obj.scanned_invoice = null">حذف تصویر</button>

                                    </div>

                                    <div class="col-xs-4">
                                        <img class="img-responsive img-thumbnail img-sig" ng-src="{{uploadUrl + invoice.obj.scanned_invoice}}"
                                             ng-if="invoice.obj.scanned_invoice">
                                    </div>
                                    <br/>
                                    <p ng-show="invoiceForm.file.$error.maxSize" class="input-error-p">حجم فایل انتخابی بیشتر از ۲ مگابایت است</p>
                                    <p ng-show="invoiceForm.file.$error.pattern" class="input-error-p">فرمت فایل انتخابی مجاز نیست</p>
                                </div>

                                <div class="col-xs-12" style="text-align: left">
                                    <button type="button" class="btn btn-danger" ng-click="invoice.resetInvoiceForm()">لغو</button>
                                    <button type="button" ng-if = "checkWrite('invoice')" ng-disabled="!invoiceForm.$valid" ng-click="invoice.editOrCreate(invoice.editCreate)" class="btn btn-success">ذخیره</button>
                                </div>
                            </div><!-- /.box-body -->
                        </fieldset>
                    </form>
                </div><!-- /.x_content-->
            </div><!-- /.x_panel-->
        </div>
        <!-- /edit and create column -->

    </div>

</div>



<!-- Select Modal -->
<div class="modal fade" id="selectModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="pull-left">
                  <button type="button" class="btn btn-danger" data-dismiss="modal">بستن</button>
                </div>
            </div><!-- /.modal-header -->
            <div class="modal-body">
                <div class="box-body">
                    <div class="row">
                        <div class="col-md-10 col-md-offset-1">
                            <!-- Stage 1 for buyer select -->
                            <div class="panel panel-info" ng-show="selectStage == 1">
                                <div class="panel-heading">
                                    انتخاب خریدار
                                    <div class="pull-left">
                                      <i ng-show = "loadSearch" class="fa fa-refresh fa-spin"></i>
                                    </div>
                                </div>
                                <div class="panel-body">
                                    <form name="selectBuyerForm" role="form" novalidate>
                                      <div class="input-group">
                                        <input type="text" class="form-control" name="searchText" ng-model="invoice.tmp.searchQuery" required>
                                        <span class="input-group-btn">
                                          <button type="button" ng-disabled = "selectBuyerForm.$invalid" class="btn btn-info btn-beside-input" ng-click="invoice.search('user','last_name')">جستجوی خریدار</button>
                                        </span>
                                      </div>
                                    </form>

                                    <table class="table table-hover table-border" ng-hide = "invoice.tmp.searchResult == '' || loadSearch">
                                        <tbody>
                                          <tr>
                                            <th>ردیف</th>
                                            <th>نام</th>
                                            <th>نام خانوادگی</th>
                                            <th>انتخاب</th>
                                          </tr>

                                          <tr ng-repeat = "list in invoice.tmp.searchResult">
                                            <td>{{$index+1}}</td>
                                            <td>
                                              {{list.first_name}}
                                            </td>
                                            <td>
                                              {{list.last_name}}
                                            </td>
                                            <td>
                                              <a ng-click="invoice.selectItem(list.id, list.last_name, 'last_name', 'buyer')" href>
                                                <i class="fa fa-check-square-o fa-lg"></i>
                                              </a>
                                            </td>
                                          </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div><!-- /.panel -->
                            <!-- End of Stage 1 -->

                            <!-- Stage 2 for seller select -->
                            <div class="panel panel-info" ng-show="selectStage == 2">
                                <div class="panel-heading">
                                    انتخاب فروشنده
                                    <div class="pull-left">
                                      <i ng-show = "loadSearch" class="fa fa-refresh fa-spin"></i>
                                    </div>
                                </div>
                                <div class="panel-body">
                                    <form name="selectSellerForm" role="form" novalidate>
                                      <div class="input-group">
                                        <input type="text" class="form-control" name="searchText" ng-model="invoice.tmp.searchQuery" required>
                                        <span class="input-group-btn">
                                          <button type="button" ng-disabled = "selectSellerForm.$invalid" class="btn btn-info btn-beside-input" ng-click="invoice.search('seller','last_name')">جستجوی فروشنده</button>
                                        </span>
                                      </div>
                                    </form>

                                    <table class="table table-hover table-border" ng-hide = "invoice.tmp.searchResult == '' || loadSearch">
                                        <tbody>
                                          <tr>
                                            <th>ردیف</th>
                                            <th>نام</th>
                                            <th>نام خانوادگی</th>
                                            <th>انتخاب</th>
                                          </tr>

                                          <tr ng-repeat = "list in invoice.tmp.searchResult">
                                            <td>{{$index+1}}</td>
                                            <td>
                                              {{list.first_name}}
                                            </td>
                                            <td>
                                              {{list.last_name}}
                                            </td>
                                            <td>
                                              <a ng-click="invoice.selectItem(list.id, list.last_name, 'last_name', 'seller')" href>
                                                <i class="fa fa-check-square-o fa-lg"></i>
                                              </a>
                                            </td>
                                          </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div><!-- /.panel -->
                            <!-- End of Stage 2 -->

                            <!-- Stage 3 for product select -->
                            <div class="panel panel-info" ng-show="selectStage == 3">
                                <div class="panel-heading">
                                    انتخاب کالا
                                    <div class="pull-left">
                                      <i ng-show = "loadSearch" class="fa fa-refresh fa-spin"></i>
                                    </div>
                                </div>
                                <div class="panel-body">
                                    <form name="selectProductForm" role="form" novalidate>
                                      <div class="input-group">
                                        <input type="text" class="form-control" name="searchText" ng-model="invoice.tmp.searchQuery" required>
                                        <span class="input-group-btn">
                                          <button type="button" ng-disabled = "selectProductForm.$invalid" class="btn btn-info btn-beside-input" ng-click="invoice.search('product','model')">جستجوی کالا</button>
                                        </span>
                                      </div>
                                    </form>

                                    <table class="table table-hover table-border" ng-hide = "invoice.tmp.searchResult == '' || loadSearch">
                                        <tbody>
                                          <tr>
                                            <th>ردیف</th>
                                            <th>مدل کالا</th>
                                            <th>شماره سریال</th>
                                            <th>انتخاب</th>
                                          </tr>

                                          <tr ng-repeat = "list in invoice.tmp.searchResult">
                                            <td>{{$index+1}}</td>
                                            <td>
                                              {{list.model}}
                                            </td>
                                            <td>
                                              {{list.serial_number}}
                                            </td>
                                            <td>
                                              <a ng-click="invoice.pushProduct(list.id, list.model, list.price)" href>
                                                <i class="fa fa-check-square-o fa-lg"></i>
                                              </a>
                                            </td>
                                          </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div><!-- /.panel -->
                            <!-- End of Stage 3 -->

                        </div>
                    </div>
                </div><!-- /.box-body -->
            </div><!-- /.modal-body -->
            <div class="modal-footer">
            </div><!-- /.modal-footer -->
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->



<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="pull-left close" data-dismiss="modal" aria-label="Close" ng-hide ="loadModal">
          <span aria-hidden="true">&times;</span>
        </button>
        <div class="pull-left load-spinner" ng-show = "loadModal">
          <i class="fa fa-spinner fa-pulse fa-2x" ></i>
        </div>
        <h4 class="modal-title" id="myModalLabel" ng-show = "deleteStage == 1">حذف کالا از فاکتور</h4>
        <h4 class="modal-title" id="myModalLabel" ng-show = "deleteStage == 2">حذف فاکتور</h4>
      </div>
      <div class="modal-body" ng-show = "deleteStage == 1">
        آیا مایل به حذف کالای
        "{{invoice.toDeleteTitle}}"
        هستید؟
      </div>
      <div class="modal-body" ng-show = "deleteStage == 2">
        آیا مایل به حذف فاکتور به شماره
        "{{invoice.toDeleteTitle}}"
        هستید؟
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">خیر</button>
        <button type="button" class="btn btn-success" ng-show="deleteStage == 1" ng-click="invoice.deleteProduct(invoice.toDeleteId)">بله</button>
        <button type="button" class="btn btn-success" ng-show="deleteStage == 2" ng-click="invoice.deleteObject(invoice.toDeleteId)">بله</button>
      </div>
    </div>
  </div>
</div>