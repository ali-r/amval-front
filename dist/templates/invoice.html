<div class="row">

    <!-- Search Object -->
    <search-tools sobject="invoice.searchObject" scontroller="invoice"></search-tools>
    <!-- /Search Object-->

    <!-- invoice list -->
    <div ng-class = "{'col-xs-12':!invoice.tmp.formShow , 'col-xs-6' : invoice.tmp.formShow}">
        <div class="x_panel">
            <div class="x_title">
                <h2><i class="fa"></i>لیست فاکتورها</h2>
                <button type="button" ng-if = "checkWrite('invoice')" class="btn btn-success btn-sm pull-left" name="button" ng-click="invoice.setNewInvoiceForm()">
                    فاکتور جدید
                </button>
                <div class="clearfix"></div>
            </div><!-- /.x_title-->
            <div class="x_content">
                <table class="table table-striped jambo_table asset-tables">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>شماره فاکتور</th>
                            <th>قیمت کل</th>
                            <th></th>
                            <th ng-if = "checkWrite('invoice')"></th>
                        </tr>
                    </thead>
                    <tbody ng-hide="load">
                        <tr ng-repeat = "list in invoice.note">
                            <td>{{ (page-1)*perPage + $index + 1 | pNumber}}</td>
                            <td class="limited-width-col">{{list.invoice_no  | lengthLimit:30}}</td>
                            <td class="limited-width-col">{{list.price | lengthLimit:30 | pNumber}}</td>
                            <td>
                                <a ng-click="invoice.readInvoice(list.id)" href>
                                    <i class="fa fa-lg"  ng-class = "{'fa-pencil-square-o':checkWrite('invoice') , 'fa-eye' : !checkWrite('invoice')}" aria-hidden="true"></i>
                                </a>
                            </td>
                            <td ng-if = "checkWrite('invoice')">
                                <a ng-click="invoice.openDeleteModal(list.id,list.invoice_no,2)" href>
                                    <i class="fa fa-lg fa-trash-o" aria-hidden="true"></i>
                                </a>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <req-pagination itemmeta="meta" itempage="page"></req-pagination>
            </div><!-- /.x_content-->
        </div><!-- /.x_panel-->
    </div>
    <!-- /invoice list -->

    <!-- edit and create column -->
    <div class="col-xs-6" id="invoiceEditCreateForm" esc-event="reset()">
        <div class="x_panel " ng-hide="!invoice.tmp.formShow">
            <div class="x_title">
                <h2 ng-show="editMode"><i class="fa"></i>ویرایش فاکتور</h2>
                <h2 ng-hide="editMode"><i class="fa"></i>ایجاد فاکتور جدید</h2>
                
                <div class="pull-left" ng-hide="loadSide">
                    <button type="button" class="btn btn-danger" ng-click="reset()">لغو</button>
                    <button type="button" ng-if = "checkWrite('invoice')" ng-click="invoice.validateForm()" class="btn btn-success">ذخیره</button>
                </div>

                <div class="clearfix"></div>
            </div><!-- /.x_title-->
            <div class="x_content" ng-hide="loadSide">
                <form name="invoiceForm" role="form"  novalidate ng-submit="invoice.validateForm()">
                    <button type="submit" hidden></button>
                    <fieldset ng-disabled ="!checkWrite('invoice')">
                        <div class="box-body">
                            
                            

                            <div class="row">

                                <div class="col-xs-6">
                                    <div class="form-group" ng-class=" {'has-error' : invoiceForm.invoice_no.$invalid && invoice.obj.invoice_no,
                                        'has-success' : invoiceForm.invoice_no.$valid && invoice.obj.invoice_no } ">
                                        <label>شماره فاکتور*</label>
                                        <input type="text" class="form-control" name="invoice_no" placeholder="شماره فاکتور" ng-model = "invoice.obj.invoice_no" required>
                                    </div>
                                </div>
                                <div class="col-xs-6">
                                    <div class="form-group" ng-class="{'has-success' : invoiceForm.datetime.$valid && invoice.obj.datetime}">
                                        <label>تاریخ فاکتور*</label>
                                        <adm-dtp  ng-model="invoice.obj.datetime" ></adm-dtp>
                                    </div>
                                </div>
                                <div class="clearfix"></div>

                                <div class="col-xs-6">
                                    <label>خریدار*</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" ng-model="invoice.obj.buyer.last_name" placeholder="خریدار" disabled>
                                        <span class="input-group-btn">
                                            <button type="button" class="btn btn-info btn-beside-input" ng-click="invoice.selectBuyer()">انتخاب</button>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-xs-6">
                                    <label>فروشنده*</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" ng-model="invoice.obj.seller.last_name" placeholder="فروشنده" disabled>
                                        <span class="input-group-btn">
                                            <button type="button" class="btn btn-info btn-beside-input" ng-click="invoice.selectSeller()">انتخاب</button>
                                        </span>
                                    </div>
                                </div>
                                <div class="clearfix"></div>

                                <div class="col-xs-6">
                                    <label>قیمت کل*</label>
                                    <input type="number" min="0" step="1" class="form-control form-ltr" ng-model="invoice.obj.price">
                                </div>
                                <div class="col-xs-6">
                                    <label>تعداد کالا*</label>
                                    <input type="number" min="0" step="1" class="form-control form-ltr" ng-model="invoice.obj.num_of_products">
                                </div>
                                <div class="clearfix"></div>
                            </div>
                            
                            <hr>
                            <div class="row">
                                <div class="col-xs-6">
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-info" ng-click="invoice.openProductModal()">ایجاد کالا</button>
                                        <button type="button" class="btn btn-info" ng-click="invoice.selectProduct()">انتخاب کالا</button>
                                    </span>
                                </div>
                            </div>
                            <br>
                            <table class="table table-striped asset-tables" ng-show="invoice.obj.products.length > 0">
                                <colgroup>
                                    <col span="1" style="width: 60%;">
                                    <col span="1" style="width: 35%;">
                                    <col span="1" style="width: 5%;">
                                </colgroup>
                                <thead>
                                    <tr>
                                        <th>نام کالا</th>
                                        <th>قیمت</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody ng-repeat = "product in invoice.obj.products">
                                    <tr>
                                        <td> {{product.model | lengthLimit:30}} </td>
                                        <td> 
                                            <input placeholder="بدون قیمت" dir="ltr" type="number" step="1" min="0" class="longer-limited-width-col" name="productPrice" ng-model="product.price" required>
                                        </td>
                                        <td ng-if = "checkWrite('invoice')">
                                            <a ng-click="invoice.openDeleteModal($index,product.model,1)" href>
                                                <i class="fa fa-lg fa-trash-o" aria-hidden="true"></i>
                                            </a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <div ng-show="invoiceForm.productPrice.$invalid && invoice.obj.products.length > 0" style="text-align:right">
                                <p class="text-danger">
                                    -
                                    قیمت کالا ها را به درستی وارد کنید
                                </p>
                            </div>

                            <hr></hr>

                            <div class="row">
                                <div class="col-xs-4">
                                    <label>تصویر فاکتور*</label>
                                </div>
                                <div class="col-xs-6">
                                    <div class="btn btn-info btn-sm" ngf-select="invoice.uploadPic()" ng-model="invoice.scannedFile" name="file" ngf-pattern="'.jpg,.png,.jpeg,.png'"
                                            ngf-accept="'image/*'" ngf-max-size="2MB" ng-if="!invoice.obj.scanned_invoice && checkWrite('invoice')" ng-hide="uploading" required>افزودن تصویر</div>

                                    <button type="button" class="btn btn-sm btn-danger" ng-if="invoice.obj.scanned_invoice && checkWrite('invoice')"
                                            ng-click=" invoice.obj.scanned_invoice = null">حذف تصویر</button>
                                    <div ng-show = "uploading">
                                        <p ng-show = "uploading" style="text-align : center;">
                                        در حال  بارگذاری
                                        <i class="fa fa-refresh fa-spin fa-lg"></i>
                                        </p>
                                    </div>

                                </div>

                                <div class="col-xs-2">
                                    
                                    <a href="{{uploadUrl + invoice.obj.scanned_invoice}}" data-lightbox="تصویر فاکتور" data-title="تصویر فاکتور">
                                       <img class="img-responsive img-thumbnail" ng-src="{{uploadUrl + invoice.obj.scanned_invoice}}" ng-if="invoice.obj.scanned_invoice">
                                    </a>
                                    
                                </div>
                                <br/>
                                <p ng-show="invoiceForm.file.$error.maxSize" class="input-error-p">حجم فایل انتخابی بیشتر از ۲ مگابایت است</p>
                                <p ng-show="invoiceForm.file.$error.pattern" class="input-error-p">فرمت فایل انتخابی مجاز نیست</p>
                                
                            </div>
                            
                            <hr></hr>



                            <div style="text-align:right" ng-hide = "invoiceForm.$valid && invoice.obj.products.length>0">
                                <p> 
                                  پر کردن فیلد هایی که با * مشخص شده اجباری است.
                                </p>
                            </div>

                            <div class="col-xs-12" style="text-align: center">
                                <!-- <ul>
                                    <li ng-repeat="(key, errors) in invoiceForm.$error track by $index"> <strong>{{ key }}</strong> errors
                                        <ul>
                                        <li ng-repeat="e in errors">{{ e.$name }} has an error: <strong>{{ key }}</strong>.</li>
                                        </ul>
                                    </li>
                                </ul> -->
                            </div>

                            

                        </div><!-- /.box-body -->
                    </fieldset>
                </form>
            </div><!-- /.x_content-->
            <div class="load-spinner" ng-show = "loadSide" style="text-align:center">
              <i class="fa fa-spinner fa-pulse fa-3x" ></i>
            </div>
        </div><!-- /.x_panel-->
    </div>
    <!-- /edit and create column -->

</div>

<!-- Select Modal -->
<div class="modal fade" id="selectModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="pull-left">
                  <button type="button" class="btn btn-danger" data-dismiss="modal">بستن</button>
                </div>
            </div><!-- /.modal-header -->
            <div class="modal-body">
                <div class="box-body">
                    <div class="row">
                        <div class="col-md-12">
                            <!-- Stage 1 for buyer select -->
                            <div class="panel panel-info" ng-show="selectStage == 1">
                                <div class="panel-heading">
                                    انتخاب خریدار
                                    <div class="pull-left">
                                      <i ng-show = "loadSearch" class="fa fa-refresh fa-spin"></i>
                                    </div>
                                </div>
                                <div class="panel-body">
                                    <form name="selectBuyerForm" role="form" novalidate>
                                      <div class="input-group">
                                        <input type="text" class="form-control" name="searchText" ng-model="invoice.tmp.searchField" required>
                                        <span class="input-group-btn">
                                          <button type="button" ng-disabled = "selectBuyerForm.$invalid" class="btn btn-info btn-beside-input" ng-click="invoice.search('user','last_name')">جستجوی خریدار</button>
                                        </span>
                                      </div>
                                    </form>

                                    <table class="table table-hover table-border" ng-hide = "invoice.tmp.searchResult == '' || loadSearch">
                                        <tbody>
                                          <tr>
                                            <th>ردیف</th>
                                            <th>نام</th>
                                            <th>نام خانوادگی</th>
                                            <th>انتخاب</th>
                                          </tr>

                                          <tr ng-repeat = "list in invoice.tmp.searchResult">
                                            <td>{{$index+1}}</td>
                                            <td>
                                              {{list.first_name | lengthLimit:15}}
                                            </td>
                                            <td>
                                              {{list.last_name | lengthLimit:15}}
                                            </td>
                                            <td>
                                              <a ng-click="invoice.selectItem(list.id, list.last_name, 'last_name', 'buyer')" href>
                                                <i class="fa fa-check-square-o fa-lg"></i>
                                              </a>
                                            </td>
                                          </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div><!-- /.panel -->
                            <!-- End of Stage 1 -->

                            <!-- Stage 2 for seller select -->
                            <div class="panel panel-info" ng-show="selectStage == 2">
                                <div class="panel-heading">
                                    انتخاب فروشنده
                                    <div class="pull-left">
                                      <i ng-show = "loadSearch" class="fa fa-refresh fa-spin"></i>
                                    </div>
                                </div>
                                <div class="panel-body">
                                    <form name="selectSellerForm" role="form" novalidate>
                                      <div class="input-group">
                                        <input type="text" class="form-control" name="searchText" ng-model="invoice.tmp.searchField" required>
                                        <span class="input-group-btn">
                                          <button type="button" ng-disabled = "selectSellerForm.$invalid" class="btn btn-info btn-beside-input" ng-click="invoice.search('seller','last_name')">جستجوی فروشنده</button>
                                        </span>
                                      </div>
                                    </form>

                                    <table class="table table-hover table-border" ng-hide = "invoice.tmp.searchResult == '' || loadSearch">
                                        <tbody>
                                          <tr>
                                            <th>ردیف</th>
                                            <th>نام</th>
                                            <th>نام خانوادگی</th>
                                            <th>انتخاب</th>
                                          </tr>

                                          <tr ng-repeat = "list in invoice.tmp.searchResult">
                                            <td>{{$index+1}}</td>
                                            <td>
                                              {{list.first_name | lengthLimit:15}}
                                            </td>
                                            <td>
                                              {{list.last_name | lengthLimit:15}}
                                            </td>
                                            <td>
                                              <a ng-click="invoice.selectItem(list.id, list.last_name, 'last_name', 'seller')" href>
                                                <i class="fa fa-check-square-o fa-lg"></i>
                                              </a>
                                            </td>
                                          </tr>
                                        </tbody>
                                    </table>

                                    

                                </div>
                            </div><!-- /.panel -->
                            <!-- End of Stage 2 -->

                            <!-- Stage 3 for product select -->
                            <div class="panel panel-info" ng-show="selectStage == 3">
                                <div class="panel-heading">
                                    انتخاب کالا
                                    <div class="pull-left">
                                      <i ng-show = "loadSearch" class="fa fa-refresh fa-spin"></i>
                                    </div>
                                </div>
                                <div class="panel-body">
                                    <div class="row" ng-show="invoice.obj.products.length>0">
                                        <ul class="remove-box">
                                            <li ng-repeat="item in invoice.obj.products track by item.id">
                                                <span ng-click="invoice.deselect($index)">×</span>
                                                {{item.model | limitTo : 10}}
                                            </li>
                                        </ul>
                                        <hr/>
                                    </div>

                                    <form name="selectProductForm" role="form" novalidate>
                                      <div class="input-group">
                                        <input type="text" class="form-control" name="searchText" placeholder="مدل کالا را وارد کنید" ng-model="invoice.tmp.searchField" required>
                                        <span class="input-group-btn">
                                          <button type="button" ng-disabled = "selectProductForm.$invalid" class="btn btn-info btn-beside-input" ng-click="invoice.search('product','?use_case=0&model__contains=' + invoice.tmp.searchField)">جستجوی کالا</button>
                                        </span>
                                      </div>
                                    </form>


                                    <table class="table table-hover table-border" ng-hide = "invoice.tmp.searchResult == '' || loadSearch">
                                        <tbody>
                                          <tr>
                                            <th>ردیف</th>
                                            <th>مدل کالا</th>
                                            <th>شماره سریال</th>
                                            <th>انتخاب</th>
                                          </tr>

                                          <tr  ng-repeat = "list in invoice.tmp.searchResult">
                                            <td >{{$index+1}}</td>
                                            <td>
                                              {{list.model | lengthLimit:15}}
                                            </td>
                                            <td>
                                              {{list.serial_number | lengthLimit:15}}
                                            </td>
                                            <td>
                                              <a ng-show="invoice.checkDuplicate(list, invoice.obj.products)" ng-click="invoice.pushProduct(list)" href>
                                                <i class="fa fa-check-square-o fa-lg"></i>
                                              </a>
                                                <i ng-hide="invoice.checkDuplicate(list, invoice.obj.products)">موجود</i>
                                            </td>
                                          </tr>
                                        </tbody>
                                    </table>
                                </div>

                            </div><!-- /.panel -->
                            <!-- End of Stage 3 -->

                        </div>
                    </div>
                </div><!-- /.box-body -->
            </div><!-- /.modal-body -->
            <div class="modal-footer">
            </div><!-- /.modal-footer -->
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->



<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
enter-event="deleteStage==1,invoice.deleteProduct(invoice.toDeleteId),invoice.deleteObject(invoice.toDeleteId)">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="pull-left close" data-dismiss="modal" aria-label="Close" ng-hide ="loadModal">
          <span aria-hidden="true">&times;</span>
        </button>
        <div class="pull-left load-spinner" ng-show = "loadModal">
          <i class="fa fa-spinner fa-pulse fa-2x" ></i>
        </div>
        <h4 class="modal-title" id="myModalLabel" ng-show = "deleteStage == 1">حذف کالا از فاکتور</h4>
        <h4 class="modal-title" id="myModalLabel" ng-show = "deleteStage == 2">حذف فاکتور</h4>
      </div>
      <div class="modal-body" ng-show = "deleteStage == 1">
        آیا مایل به حذف کالای
        <div class="longer-limited-width-col">
            "{{invoice.toDeleteTitle  | lengthLimit:30}}"
        </div >
        هستید؟
      </div>
      <div class="modal-body" ng-show = "deleteStage == 2">
        آیا مایل به حذف فاکتور به شماره
        <div class="longer-limited-width-col">
            "{{invoice.toDeleteTitle  | lengthLimit:30}}"
        </div>
        هستید؟
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">خیر</button>
        <button type="button" class="btn btn-success" ng-show="deleteStage == 1" ng-click="invoice.deleteProduct(invoice.toDeleteId)">بله</button>
        <button type="button" class="btn btn-success" ng-show="deleteStage == 2" ng-click="invoice.deleteObject(invoice.toDeleteId)">بله</button>
      </div>
    </div>
  </div>
</div>

<creat-product controller = "invoice"></creat-product>